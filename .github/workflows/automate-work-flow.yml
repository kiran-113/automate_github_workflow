# .github/workflows/main_pipeline.yml
name: CI/CD Pipeline with Branch-Specific Workflows

on:
  pull_request:
    branches:
      - 'dev'
      - 'stage'
      - 'test'
      - 'prod'
    types:
      - closed

jobs:
  handle_pr_merge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v2

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Fetch all branches
      run: git fetch origin +refs/heads/*:refs/remotes/origin/*

    - name: Merge changes into main
      run: |
        git checkout main
        git merge --no-ff origin/${{ github.event.pull_request.base.ref }} --allow-unrelated-histories

    - name: Push changes to main branch
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: git push origin main

    # Trigger the Dev Workflow
    - name: Trigger Dev Workflow via GitHub API
      run: |
        curl -X POST -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/dev.yml/dispatches \
          -d '{"ref": "main", "inputs": {"branch": "main"}}'
